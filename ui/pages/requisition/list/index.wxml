<view class="page">
  <block wx:if="{{loading}}">
    <view class="loading">加载中...</view>
  </block>
  <block wx:elif="{{items.length}}">
    <view class="cell-group">
      <view class="cell" wx:for="{{items}}" wx:key="id">
        <view class="cell-header">
          <view class="cell-info">
            <text class="cell-title">{{item.productName}}</text>
            <text class="cell-desc">{{item.baseName}}{{item.spec ? (' · ' + item.spec) : ''}}{{item.requesterName ? (' · ' + item.requesterName) : ''}}</text>
          </view>
          <view class="cell-meta">
            <text class="amount">{{item.currency}} {{item.totalAmountFmt}}</text>
            <text class="cell-desc">{{item.requestDate}}</text>
          </view>
        </view>
        <view class="cell-stats">
          <text>单价：{{item.currency}} {{item.unitPriceFmt}}</text>
          <text>数量：{{item.quantityBase}}</text>
        </view>
        <view class="cell-actions">
          <button size="mini" bindtap="onReceiptAction" data-id="{{item.id}}">票据</button>
          <button size="mini" bindtap="onEdit" data-id="{{item.id}}">编辑</button>
          <button size="mini" type="warn" bindtap="onDelete" data-id="{{item.id}}">删除</button>
        </view>
      </view>
    </view>
  </block>
  <view wx:else class="empty">暂无物资申领记录</view>

  <view class="fab" bindtap="openCreate" style="{{fabStyle}}">
    <view class="fab-inner">
      <view class="fab-bar"></view>
      <view class="fab-bar v"></view>
    </view>
  </view>

  <view class="sheet" wx:if="{{formOpen}}">
    <view class="sheet-body">
      <view class="row between">
        <text class="sheet-title">{{form.id ? '编辑物资申领' : '新增物资申领'}}</text>
        <button size="mini" bindtap="closeForm">关闭</button>
      </view>
      <scroll-view scroll-y class="sheet-scroll">
        <view class="cell-group">
          <view class="cell">
            <text class="cell-label">基地</text>
            <picker mode="selector" range="{{basePickerNames}}" value="{{baseIndex}}" bindchange="onBaseChange">
              <view class="picker">{{basePickerNames[baseIndex]}}</view>
            </picker>
          </view>
          <view class="cell">
            <text class="cell-label">商品</text>
            <picker mode="selector" range="{{productPickerNames}}" value="{{productIndex}}" bindchange="onProductChange">
              <view class="picker">{{productPickerNames[productIndex]}}</view>
            </picker>
          </view>
          <view class="cell">
            <text class="cell-label">数量</text>
            <input class="input" type="digit" value="{{form.quantity}}" bindinput="onQuantityInput" placeholder="请输入数量" />
          </view>
          <view class="cell">
            <text class="cell-label">单位</text>
            <picker mode="selector" range="{{unitPickerNames}}" value="{{unitIndex}}" bindchange="onUnitChange">
              <view class="picker">{{unitPickerNames[unitIndex] || '请选择单位'}}</view>
            </picker>
          </view>
          <view class="cell">
            <text class="cell-label">单价</text>
            <input class="input" type="digit" value="{{form.unit_price}}" bindinput="onPriceInput" placeholder="请输入单价" />
          </view>
          <view class="cell">
            <text class="cell-label">申领日期</text>
            <picker mode="date" value="{{form.request_date}}" bindchange="onDateChange">
              <view class="picker">{{form.request_date}}</view>
            </picker>
          </view>
        </view>
        <view class="form-summary">
          <text>预估总额：{{form.currency || 'CNY'}} {{formTotalFmt}}</text>
        </view>
      </scroll-view>
      <view class="sheet-footer">
        <button class="btn-primary" style="background: {{themeColor}}; border-color: {{themeColor}};" bindtap="save" loading="{{saving}}">保存</button>
      </view>
    </view>
  </view>

  <bottom-nav active="inventory" />
</view>
