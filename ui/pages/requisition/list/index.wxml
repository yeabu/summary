<view class="page {{deviceProfileClass}}">
  <block wx:if="{{loading}}">
    <view class="loading">加载中...</view>
  </block>
  <block wx:elif="{{items.length}}">
    <view class="cell-group">
      <view class="cell" wx:for="{{items}}" wx:key="id">
        <view class="cell-header">
          <view class="cell-info">
            <text class="cell-title">{{item.productName}}</text>
            <text class="cell-desc">{{item.baseName}}{{item.spec ? (' · ' + item.spec) : ''}}{{item.requesterName ? (' · ' + item.requesterName) : ''}}</text>
          </view>
          <view class="cell-meta">
            <text class="amount">{{item.currency}} {{item.totalAmountFmt}}</text>
            <text class="cell-desc">{{item.requestDate}}</text>
          </view>
        </view>
        <view class="cell-stats">
          <text>单价：{{item.currency}} {{item.unitPriceFmt}}</text>
          <text>数量：{{item.quantityBase}}</text>
        </view>
        <view class="cell-actions">
          <button size="mini" bindtap="onReceiptAction" data-id="{{item.id}}">票据</button>
          <button size="mini" bindtap="onEdit" data-id="{{item.id}}">编辑</button>
          <button size="mini" type="warn" bindtap="onDelete" data-id="{{item.id}}">删除</button>
        </view>
      </view>
    </view>
  </block>
  <view wx:else class="empty">暂无物资申领记录</view>

  <view class="fab" bindtap="openCreate" style="{{fabStyle}}">
    <view class="fab-inner">
      <view class="fab-bar"></view>
      <view class="fab-bar v"></view>
    </view>
  </view>

  <view class="sheet" wx:if="{{formOpen}}">
    <view class="sheet-body">
      <view class="sheet-header with-actions">
        <text class="sheet-title">{{form.id ? '编辑物资申领' : '新增物资申领'}}</text>
        <view class="sheet-actions">
          <button class="btn-secondary" size="mini" style="color: {{themeColor}}; border-color: {{themeColor}};" bindtap="closeForm">取消</button>
          <button class="btn-primary" size="mini" style="background: {{themeColor}}; border-color: {{themeColor}};" bindtap="save" loading="{{saving}}">保存</button>
        </view>
      </view>
      <scroll-view scroll-y class="sheet-scroll">
        <view class="cell-group">
          <view class="cell-row">
            <view class="cell half">
              <text class="cell-label">基地</text>
              <picker mode="selector" range="{{basePickerNames}}" value="{{baseIndex}}" bindchange="onBaseChange">
                <view class="picker">{{basePickerNames[baseIndex]}}</view>
              </picker>
            </view>
            <view class="cell half">
              <text class="cell-label">申领日期</text>
              <picker mode="date" value="{{form.request_date}}" bindchange="onDateChange">
                <view class="picker">{{form.request_date}}</view>
              </picker>
            </view>
          </view>
        </view>
        <view class="form-section">
          <view class="section-header">
            <text class="section-title">申领明细</text>
            <button size="mini" bindtap="addItem" wx:if="{{!form.id}}">新增明细</button>
          </view>
          <view class="section-list">
            <block wx:for="{{formItems}}" wx:key="index">
              <view class="item-card">
                <view class="item-header">
                  <text>明细 {{index + 1}}</text>
                  <button size="mini" type="warn" data-index="{{index}}" bindtap="removeItem" wx:if="{{formItems.length > 1}}">删除</button>
                </view>
                <view class="item-body">
                  <view class="item-field">
                    <text class="cell-label">商品</text>
                    <picker mode="selector" range="{{productPickerNames}}" value="{{item.productIndex}}" data-index="{{index}}" bindchange="onItemProductChange">
                      <view class="picker">{{item.productIndex > 0 ? productPickerNames[item.productIndex] : '请选择商品'}}</view>
                    </picker>
                  </view>
                  <view class="item-row">
                    <view class="item-field half">
                      <text class="cell-label">数量</text>
                      <input class="input" type="digit" value="{{item.quantity}}" data-index="{{index}}" bindinput="onItemQuantityInput" placeholder="0" />
                    </view>
                    <view class="item-field half">
                      <text class="cell-label">单位</text>
                      <picker mode="selector" range="{{item.unitPickerNames}}" value="{{item.unitIndex}}" data-index="{{index}}" bindchange="onItemUnitChange">
                        <view class="picker">{{item.unitIndex > 0 ? item.unitPickerNames[item.unitIndex] : '选择单位'}}</view>
                      </picker>
                    </view>
                  </view>
                  <view class="item-row">
                    <view class="item-field half">
                      <text class="cell-label">单价</text>
                      <input class="input" type="digit" value="{{item.unit_price}}" data-index="{{index}}" bindinput="onItemPriceInput" placeholder="0.00" />
                    </view>
                    <view class="item-field half">
                      <text class="cell-label">币种</text>
                      <picker mode="selector" range="{{currencyOptions}}" value="{{item.currencyIndex}}" data-index="{{index}}" bindchange="onItemCurrencyChange">
                        <view class="picker">{{currencyOptions[item.currencyIndex] || item.currency}}</view>
                      </picker>
                    </view>
                  </view>
                  <view class="item-summary">
                    <text>小计：{{item.currency || 'CNY'}} {{item.subtotalFmt}}</text>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </view>
        <view class="form-summary">
          <text>预估总额：{{formCurrency}} {{formTotalFmt}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <bottom-nav active="inventory" />
</view>
